---
title: "Patternograms as a diagnostic tool in spatial machine learning"
author: Jakub Nowosad
date: "`r Sys.Date()`"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Let's start by attaching the necessary packages.

```{r setup}
#| message: false
library(patternogram)
library(sf)
library(terra)
library(rpart)
```

<!-- intro -->

Next, we load two spatial datasets.
The first one is a spatial vector point dataset with annual average air temperature measurements in Celsius for Spain in 2019.
The second one is a raster dataset with predictors, such as population density (`popdens`), distance to the coast (`coast`), elevation (`dem`), a satellite-based Normalized Difference Vegetation Index (`ndvi`), and annual average composites of the Land Surface Temperature product for day (`lst_day`) and night (`lst_night`).

```{r}
temp_train = read_sf("/vsicurl/https://github.com/Nowosad/IIIRqueR_workshop_materials/raw/refs/heads/main/data/temp_train.gpkg")
plot(temp_train)

predictors = rast("/vsicurl/https://github.com/Nowosad/IIIRqueR_workshop_materials/raw/refs/heads/main/data/predictors.tif")
plot(predictors, axes = FALSE)
```

```{r}
p_temp_train = patternogram(temp_train)
plot(p_temp_train)
```


```{r}
nx = minmax(predictors)    
pr = (predictors - nx[1, ]) / (nx[2, ] - nx[1, ])
```

```{r}
temp = extract(pr, temp_train, ID = FALSE)
temp_train_all = cbind(temp_train, temp)
```

```{r}
p_train_pred = patternogram(temp_train_all[-1])
plot(p_train_pred)
```

```{r}
p_pr = patternogram(pr)
plot(p_pr)
```

```{r}
plot(c(p_train_pred, p_pr))
```


```{r}
p_train_pred2 = patternogram(temp_train_all[-1], group = TRUE)
plot(p_train_pred2)
```

```{r}
p_pr2 = patternogram(pr, group = TRUE)
plot(p_pr2)
```

```{r}
plot(c(p_train_pred2, p_pr2))
```

```{r}
library(ggplot2)
autoplot(c(p_train_pred2, p_pr2)) + 
  facet_wrap(~group)
```

```{r}
rpart_model = rpart(temp ~ ., data = st_drop_geometry(temp_train_all))
rpart_model
```

```{r}
var_imp = rpart_model$variable.importance
var_imp = (var_imp / sum(var_imp)) * length(var_imp)
var_imp
```

```{r}
pr = pr[[names(var_imp)]]
pr_weighted = pr * var_imp
panel(pr_weighted, axes = FALSE)
```

```{r}
p1 = patternogram(pr)
p2 = patternogram(pr_weighted)
p_12 = c(p1, p2, ids = c("unweighted", "weighted"))
plot(p_12)
```

```{r}
prediction = predict(predictors, rpart_model, na.rm = TRUE)
```

```{r}
#| layout-ncol: 2
plot(temp_train)
plot(prediction)
```

```{r}
p_prediction = patternogram(prediction)
plot(c(p_temp_train, p_prediction, ids = c("stations", "prediction")))
```
