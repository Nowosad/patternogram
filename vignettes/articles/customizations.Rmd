---
title: "Customizations and additional features of the patternogram package"
author: Jakub Nowosad
date: "`r Sys.Date()`"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The **patternogram** package provides tools for visual exploration of spatial autocorrelation of values from a set of points or a raster object.
This vignette shows various customizations and additional features available in the package.
It extends the introduction provided in the [An introduction to patternogram](an-introduction-to-patternogram.html) vignette.

Let's start by attaching the necessary packages.

```{r setup}
#| message: false
library(patternogram)
library(sf)
library(terra)
```

Next, we load two spatial datasets.
The first one is a spatial vector point dataset with annual average air temperature measurements in Celsius for Spain in 2019.
The second one is a raster dataset with predictors, such as population density (`popdens`), distance to the coast (`coast`), elevation (`dem`), a satellite-based Normalized Difference Vegetation Index (`ndvi`), and annual average composites of the Land Surface Temperature product for day (`lst_day`) and night (`lst_night`).

```{r}
temp_train = read_sf("/vsicurl/https://github.com/Nowosad/IIIRqueR_workshop_materials/raw/refs/heads/main/data/temp_train.gpkg")
plot(temp_train)

predictors = rast("/vsicurl/https://github.com/Nowosad/IIIRqueR_workshop_materials/raw/refs/heads/main/data/predictors.tif")
plot(predictors, axes = FALSE)
```

## Patternograms of point data

The `patternogram()` function is the main function of the package -- it calculates the relationship between spatial distance and dissimilarity of values and returns an object of the `patternogram` class.
When the first argument is a set of points, the function calculates distances between all pairs of points and dissimilarities between their values.

```{r}
p_tt = patternogram(temp_train)
p_tt
plot(p_tt)
```

The result of plotting a patternogram is a scatter plot showing the dissimilarity of values for different spatial distances.
However, often our point datasets are a sample of a larger population and, moreover, their values may be subject to measurement errors.
Therefore, it is useful to estimate and visualize **confidence intervals** of the dissimilarity estimates.
To do this, we can set the `interval` argument to `"confidence"`.

```{r}
p_tt_ci = patternogram(temp_train, interval = "confidence")
p_tt_ci
plot(p_tt_ci)
```

Now, the resulting patternogram contains two additional columns with lower and upper confidence intervals of the dissimilarity estimates (`ci_lower` and `ci_upper`).
These intervals are also automatically visualized in the plot.

When the `interval` argument is set to `"confidence"`, the function uses a bootstrap approach to estimate confidence intervals.
By default, it uses 100 bootstrap samples and a confidence level of 0.95; however, we may customize these settings using the `interval_opts` argument.
In the next example, we set the confidence level to 0.99 and the number of bootstrap samples to 250.

```{r}
p_tt_ci2 = patternogram(temp_train, interval = "confidence",
                        interval_opts = list(conf_level = 0.99, 
                                             n_bootstrap = 250))
plot(p_tt_ci2)
```

Now, you may notice that the confidence intervals are wider than in the previous example, which is expected when we increase the confidence level.

<!-- where to put/explain cloud? -->
```{r}
#| echo: false
#| eval: false
p_tt_cloud = patternogram(temp_train, cloud = TRUE)
p_tt_cloud
plot(p_tt_cloud)
```

## Patternograms of raster data

The raster variables have different units and ranges of values, so we need to standardize them before calculating the patternogram.
Otherwise, the variables with larger ranges will dominate the dissimilarity calculations.
To standardize the variables, we can use min-max normalization, which rescales the values of each variable to a range between 0 and 1.

```{r}
nx = minmax(predictors)    
pr = (predictors - nx[1, ]) / (nx[2, ] - nx[1, ])
```

Similarly to the point data, we can calculate a patternogram for the raster data using the `patternogram()` function.
In this case, the function randomly samples a specified number of points from the raster (500, by default) and calculates distances and dissimilarities between all pairs of these sampled points.

```{r}
p_pr = patternogram(pr)
p_pr
plot(p_pr)
```

Here, we also could estimate **confidence intervals** of the dissimilarity estimates -- we just need to set the `interval` argument to `"confidence"`.

```{r}
p_pr_ci = patternogram(pr, interval = "confidence")
p_pr_ci
plot(p_pr_ci)
```

The above patternogram shows the wider confidence intervals for larger distances, which is expected because there are fewer point pairs at larger distances.

Another option for estimating intervals is to use **uncertainty intervals**, which account for the uncertainty of the sampling process.
Such intervals are estimated using a Monte Carlo approach, where the sampling of points from the raster is repeated multiple times.
To estimate uncertainty intervals, we need to set the `interval` argument to `"uncertainty"` and to customize the confidence level and the number of Monte Carlo repetitions, we may use the `interval_opts` argument.

```{r}
p_pr_ui = patternogram(pr, interval = "uncertainty",
                       interval_opts = list(conf_level = 0.99, 
                                            n_montecarlo = 100))
p_pr_ui
plot(p_pr_ui)
```

## Combining patternograms

We may want to compare patternograms calculated for different datasets or using different settings.
To present such comparisons, let's split the `temp_train` dataset into two subsets: one with points located in the northern part of Spain and another one with points located in the southern part of Spain.

```{r}
temp_train_north = subset(temp_train, st_coordinates(temp_train)[,2] > 4420000)
temp_train_south = subset(temp_train, st_coordinates(temp_train)[,2] <= 4420000)
```

Next, we calculate patternograms for these two subsets.

```{r}
p_tt_north = patternogram(temp_train_north, interval = "confidence")
p_tt_south = patternogram(temp_train_south, interval = "confidence")
```

The resulting patternograms can be combined into a single object using the `bind_patternogram()` function.
It accepts multiple patternogram objects and an optional `ids` argument, which allows us to specify labels for each patternogram.
The resulting object is also of the `patternogram` class and can be plotted using the `plot()` function.

```{r}
p_pr_both = bind_patternogram(p_tt_north, p_tt_south, ids = c("north", "south"))
p_pr_both
plot(p_pr_both)
```

The resulting plot shows that the dissimilarity estimates for the northern part of Spain are generally higher than those for the southern part.
It means that the temperature values in the northern part of Spain are more diverse than those in the southern part.
This observation may be related to the fact that the northern part of Spain has a more varied terrain, including mountains and coastal areas, which can lead to greater temperature variability.
